name: Build and Deploy to GitHub Pages

on:
  push:
    branches: 
      - main
      - dev
  pull_request:
    branches: 
      - main
      - dev

jobs:
  build-and-deploy:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        
    - name: Initialize Hugo theme submodule
      run: |
        git submodule update --init --remote themes/hugo-bearcub || {
          git submodule deinit -f themes/hugo-coder
          rm -rf themes/hugo-bearcub
          git submodule add https://github.com/clente/hugo-bearcub.git themes/hugo-bearcub
          git submodule update --init themes/hugo-bearcub
        }

    - name: Setup Hugo
      uses: peaceiris/actions-hugo@v3
      with:
        hugo-version: 'latest'
        extended: true

    - name: Build (main branch)
      if: github.ref == 'refs/heads/main'
      run: |
        hugo --minify --baseURL https://opera-cal-val.github.io/opera-surface-displacement-blog/
        touch public/.nojekyll

    - name: Build (dev branch)
      if: github.ref == 'refs/heads/dev'
      run: |
        hugo --minify --baseURL https://opera-cal-val.github.io/opera-surface-displacement-blog/test/
        touch public/.nojekyll

    - name: Deploy main to GitHub Pages root
      if: github.ref == 'refs/heads/main'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: ./public
        destination_dir: .

    - name: Deploy dev to GitHub Pages /test/
      if: github.ref == 'refs/heads/dev'
      uses: peaceiris/actions-gh-pages@v4
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_branch: gh-pages
        publish_dir: ./public
        destination_dir: test
        keep_files: true